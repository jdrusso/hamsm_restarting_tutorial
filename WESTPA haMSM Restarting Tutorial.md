# WESTPA haMSM Restarting Tutorial

This is a tutorial of the haMSM restarting plugin, demonstrating how to use it to perform restarts on a WESTPA simulation and then compute FPT distributions.

## System Details

- NTL9 folding
- Low-friction implicit solvent ($\gamma$ = 5)
- ~600 atoms



### WE Details

- Expected runtime: **{TODO: Fill me in, with a note about the resources used}**
- Size of generated data: **{TODO: Fill me in}**
- Number of iterations: **{TODO: Fill me in. Probably 100 + 50 extension, then restarts}**



### Restarting Details

- 3 runs per restart

- 2 restarts

- A partially run simulation is provided, to reduce runtime. 

  In this simulation, the first 2 runs have completed, and the third is nearing completion. None have reached the target.

  When you run it:

  1. The third simulation will finish.

  2. With very high probability, none have reached the target, and extensions will be triggered.

     The initialized runs were chosen so it's unlikely the third will reach the target. However, it's possible that in the remaining few iterations of the third simulation, it will reach the target, in which case extensions will be skipped.

  3. After a single round of extensions, the target should be reached.

  4. The haMSM will be built from the three, extended runs.

  5. A new set of 3 runs will be restarted from the steady-state estimate.
  
     

## Background

Please see **{WESTPA 2.0 manuscript}** for more theoretical background on the models used by this plugin, and why it may be useful.



When a WESTPA run is initiated with this plugin enabled, it will:

1. Run a number of independent runs initialized from the same starting configuration for the number of iterations specified in `west.cfg`, one after another.

   - The group of runs between a pair of restarts is a "marathon"

2. If none of these have reached the target state, go through each and continue running it. Repeat this until at least one has reached the target, then continue running the rest so they're all the same length.

   - Note that, as a result, runs used for the first restart may be longer than runs in subsequent restarts.

3. Construct an haMSM from these runs, and estimate the steady-state distribution and target flux.

4. Take all structures sampled by all runs used to build this haMSM, and weight them according to steady-state.

5. Initialize a new set of (correlated, but independent from this point onward) runs from those weighted structures.

   	- Technical note: When initializing the new WE simulations, these are used as "start states". Start states are a third category of state, in addition to basis states and target states. Like basis states, they're used for seeding walker positions when initializing a simulation with `w_init`; however, *unlike* basis states, they are not used after this and walkers reaching the target state will **not** be recycled into start states.

6. Run these, one by one, for the target number of iterations.

7. Repeat from 3.

   

### Structure of plugin-specific files

This is not a complete list of all files WESTPA generates, but highlights some important files used and generated by the plugin

```
$WEST_SIM_ROOT/
	./restart.dat									[Tracks current restart/run]
	./restart_initialization.json	[User provided on start, modified by plugin during run]
	./west.h5							[Generated by WESTPA for the currently active run]
	./restart0/						[Stores data from the first restart. 0-indexed.]
	./JtargetSS.txt 			[haMSM target steady-state flux estimate]
	./pSS.txt							[haMSM steady-state distribution estimate]
	./hamsm.obj						[Pickled msm_we.ModelWE object]
	./startstates.txt			[Used for next restart, holds all weighted structures]
	./basisstates.txt			[The initial set of basis states supplied to w_init]
	./targetstates.txt		[The initial set of target states supplied to w_init]
	./structs/						[Complete set of structure files for all structures in startstates]
	./run*/								[Backed up traj_segs, seg_logs, and west.h5 from each run in this marathon. 1-indexed.]
	./[*].pdf							[Various auto-generated plots]
	./restart*/						[Other restarts]
							
```

Additionally, the user should supply a `restart_overrides.py` file somewhere, as described in the documentation.

### Normal plugin behavior

When a WESTPA simulation is initialized with the restarting plugin enabled, the plugin does the following:

1. Perform a marathon -- run `n_runs` WESTPA simulations, all initialized from the same basis states (but otherwise independent).

2. Check to see if any have reached the target.

3. If not, continue each run for `extension_iters` more iterations, and then repeat from Step 2.

4. Build haMSM using all runs.
   - Note -- this uses only the first and last frame of each iteration, which effectively sets the lag-time equal to the WE resampling time.
   
5. Estimate steady-state distribution and steady-state target flux.

6. Obtain weights for every visited structure.

7. Produce a list of start-states, using every visited structure and its associated weight.

8. Save model, steady state estimate, steady-state flux estimate, and list of start-states.

9. Initialize a new set of `n_runs` WESTPA simulations from this set of start-states and the original basis state(s).

10. Run each simulation for `n_runs` .
    - No extensions are necessary, because the initialized system already has the full space populated in some estimate of steady state, so the target should always be reached.
    
11. Repeat from 4.

    

## Steps

### System preparation

1. Clone the tutorial repository

2. Prepare the usual WESTPA files

3. Examine haMSM-plugin-specific configuration

   - `west.cfg`

     The haMSM restarting plugin requires a number of parameters to be set in `west.cfg`.

     Details on parameters are listed at https://westpa.readthedocs.io/en/latest/documentation/ext/westpa.westext.hamsm_restarting.html#west-cfg.

     **{TODO: This link is of course not active until the plugin gets merged in, but the doc page will exist in the local build of the docs}**

     

   - `restart_initialization.json`

     When initializing each run, the plugin needs to know what configuration it should be launched with. After the first restart, this is automatically generated. 

     However, *before* the first restart (i.e. in producing the initial set of runs in Workflow Step 1), there's no way for the plugin to determine how the first run was initialized. So, the parameters initially passed to `w_init` must be manually entered into `restart_initialization.json`.

     

   - `westpa_scripts/restart_overrides.py`

     When building the haMSM, some dimensionality reduction is typically necessary as it's generally neither practical *nor useful* to analyze the model on the full set of coordinates.

     This dimensionality reduction is *highly* system-specific, so no general procedure is distributed with the plugin. Instead, the user is required to define a function which takes in an array of full-atomic coordinates of shape `(n_segments, n_atoms, 3)` , does the desired dimensionality reduction, and returns the reduced coordinates in an array of shape `(n_segments, n_features)`.

     This function is then loaded by the haMSM analysis code at run-time, and used throughout.

     

### Simulation execution

Now, we're ready to actually run the simulation. This is done just like a standard WESTPA simulation -- the plugin will automatically perform all the restarting and analysis.

- Typically, you would initialize the system using `w_init` like a standard WESTPA simulation. This tutorial uses a pre-prepared system to reduce runtime, so this should not be run (unless you want to run everything from scratch).

1. `w_run` **{TODO: Fill in the actual arguments}**

**{TODO: Maybe better to provide shell scripts for these?}**

After launching the simulation with w_run, you should see a run finish a few iterations and complete. 

After completing the first WESTPA run, the target has almost certainly not been reached, and a round of extensions will automatically be launched and run.

This round of extensions will likely reach the target in at least one run (or if not, more extensions will automatically launch until it is).

After every set of extensions, the plugin will check if the target has been reached. If not, it'll launch more as mentioned above. If it has, it will build an haMSM, obtain structure weights for each visited structure, and perform a restart of a new set of WESTPA runs  (marathon) initialized from those weighted structures.



### Data analysis with `msm_we`

After the plugin finishes running, each run has a west.h5 associated with it, and each marathon has an haMSM associated with it, stored as a pickled `hamsm.obj`. Although when using the plugin it will automatically build the haMSMs, haMSM analysis can also be manually performed on WESTPA data with the `msm_we` library (which is used internally by the plugin).

For this, you can use either the data generated by the steps above, or pre-prepared west.h5 files which contain data from similar situations. This largely follows the `msm_we` usage instructions provided in the [`msm_we` documentation](https://jdrusso.github.io/msm_we/usage.html).

For this section, please refer to the Jupyter notebook provided along with this tutorial.

